#!/usr/bin/env atkins
# Atkins CI: https://github.com/titpetric/atkins

name: Vuego CI pipeline

vars:
  name: vuego

jobs:
  default:
    desc: "Format, lint and test"
    steps:
      - task: fmt
      - task: lint
      - task: test
      - task: cover

  fmt:
    desc: "Format the code"
    steps:
      - goimports -w -local $(go list .) .
      - goimports-reviser -set-alias -format -imports-order "std,blanked,general,company,project" ./...
      - go fmt ./...
      - go mod tidy

  lint:
    desc: "Lint the code"
    parallel: true
    passthru: true
    steps:
      - go-fsck lint ./... --exclude imports,func-args || true
      - golangci-lint run --fix ./... || true

  test:
    desc: "Run built tests"
    passthru: true
    tty: true
    steps:
      - go test -cover -coverpkg github.com/titpetric/vuego/... -coverprofile=pkg.cov -json ./... > test.json
      - cat test.json | gotestsum

  cover:
    desc: "Show source coverage"
    steps:
      - go-fsck extract . --include-sources
      - go-fsck docs > docs/api.md
      - go tool cover -func=pkg.cov | summary coverfunc --json > pkg.cov.json
      - go-fsck extract --pretty-json ./...
      - go-fsck coverage -c pkg.cov.json -o go-fsck.json
      - go-fsck coverage --template=docs/testing-coverage.md.tpl -v > docs/testing-coverage.md
      - perl -pi -e 's/github.com\/titpetric/titpetric/g' docs/testing-coverage.md
      - task mdox:fmt
