#!/usr/bin/env atkins
# Atkins CI: https://github.com/titpetric/atkins

name: Vuego CI pipeline

vars:
  name: vuego

jobs:
  fmt:
    desc: "Format the code"
    steps:
      - goimports -w -local $(go list .) .
      - goimports-reviser -set-alias -format -imports-order "std,blanked,general,company,project" ./...
      - go fmt ./...
      - go mod tidy

  test:
    depends_on: fmt
    steps:
      - task: lint
      - task: test:build
      - task: test:run

  lint:
    desc: "Lint the code"
    parallel: true
    steps:
      - go-fsck lint ./... --exclude imports
      - golangci-lint run --fix ./...

  test:build:
    desc: "Build tests"
    steps:
      - go-fsck test -cover -coverpkg=./... -c -o bin/ ./...

  test:run:
    desc: "Run built tests"
    steps:
      - rm -rf coverage
      - for: item in $(ls ./bin/*.test | xargs -n1 basename)
        task: test:detail
        detach: true

  test:detail:
    dest: "Collect per-function test runs"
    requires: [item]
    steps:
      - mkdir -p coverage/${{item}}
      - for: funcName in $(./bin/${{ item }} -test.list ^Test.)
        summarize: true
        run: ./bin/${{ item }} -test.coverprofile "./coverage/${{item}}/${{ funcName }}.cov" -test.run "^${{ funcName }}$"
